<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Last.fm Top 50 (2008–2025) — Bump Chart + YouTube</title>
  <style>
    :root {
      --bg: #0f0f12;
      --panel: #15161a;
      --text: #e8e8ec;
      --muted: #a3a3ad;
      --grid: #2a2b31;
      --dark-pink: #c2187a;   /* in 2008 top 50 */
      --light-pink: #f48fb1;  /* entered after 2008 */
      --light-gray: #bdbdc7;  /* rank > 50 in 2025 */
      --accent: #8ab4f8;
    }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 16px 20px; background: var(--panel); position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,.35); }
    header h1 { font-size: 18px; margin: 0; font-weight: 650; letter-spacing: .2px; }
    main { padding: 14px 14px 24px; }
    .chart-wrap { background: var(--panel); border-radius: 14px; padding: 14px; box-shadow: 0 6px 30px rgba(0,0,0,.35); }
    .legend { display: flex; gap: 18px; align-items: center; flex-wrap: wrap; margin: 8px 2px 12px; font-size: 13px; color: var(--muted); }
    .legend .swatch { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 6px; vertical-align: -2px; }
    svg { width: 100%; height: auto; display: block; }
    .axis line, .axis path { stroke: var(--grid); }
    .axis text { fill: var(--muted); font-size: 11px; }
    .gridline { stroke: var(--grid); stroke-dasharray: 2 2; }
    .series { fill: none; stroke-width: 2.6px; opacity: .7; transition: opacity .2s ease, stroke-width .15s ease; mix-blend-mode: screen; cursor: pointer; }
    .series.hidden { opacity: .12; }
    .series.highlight { stroke-width: 4px; opacity: 1; filter: drop-shadow(0 0 2px rgba(255,255,255,0.25)); }
    .dot { pointer-events: none; }
    .label { font-size: 10px; fill: var(--text); paint-order: stroke; stroke: #0f0f12; stroke-width: 3px; }
    .tooltip { position: fixed; pointer-events: none; padding: 10px 12px; background: #101116; color: var(--text); border: 1px solid #2e3037; border-radius: 10px; font-size: 12px; max-width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,.45); z-index: 9999; display: none; }
    .year-chip { fill: var(--text); font-weight: 700; font-size: 12px; }
    .status { font-size: 13px; color: var(--muted); margin-top: 8px; }

    /* Hide y-axis markers */
    .y-axis .tick text { display: none; }
    .y-axis .tick line { display: none; }
    .y-axis path { display: none; }

    /* Player panel */
    .player-panel {
      position: fixed;
      inset: auto 16px 16px auto; /* default bottom-right */
      width: min(520px, 92vw);
      background: #0f1117;
      border: 1px solid #2e3037;
      border-radius: 12px;
      box-shadow: 0 14px 60px rgba(0,0,0,.55);
      z-index: 10000;
      display: none;
      overflow: hidden;
    }
    .player-head {
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; padding: 10px 12px; background: #151922; border-bottom: 1px solid #2e3037;
    }
    .player-title {
      font-size: 14px; font-weight: 650; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .player-controls { display: flex; gap: 8px; }
    .btn {
      border: 0; background: #263041; color: var(--text); border-radius: 8px; padding: 6px 10px; cursor: pointer; font-weight: 600;
    }
    .btn:hover { background: #2d3a50; }
    .btn-close { background: #3a2531; }
    .btn-close:hover { background: #4a2b3b; }
    .player-body { aspect-ratio: 16 / 9; background: #0d0f14; }
    .player-body iframe { width: 100%; height: 100%; border: 0; display: block; }
    .player-hint {
      padding: 8px 12px; font-size: 12px; color: var(--muted); background: #101319; border-top: 1px solid #2e3037;
    }
  </style>
</head>
<body>
  <header>
    <h1>Last.fm Top 50 — 2008 to 2025</h1>
  </header>
  <main>
    <div class="chart-wrap">
      <div class="legend">
        <span><span class="swatch" style="background: var(--dark-pink)"></span> In 2008 Top 50</span>
        <span><span class="swatch" style="background: var(--light-pink)"></span> Entered after 2008</span>
        <span><span class="swatch" style="background: var(--light-gray)"></span> Rank &gt; 50</span>
      </div>
      <svg id="chart" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet"></svg>
      <div class="status" id="status">Loading lastfm_top50.csv…</div>
    </div>
  </main>
  <div class="tooltip" id="tooltip"></div>

  <!-- Click-to-play YouTube panel -->
  <div id="playerPanel" class="player-panel" role="dialog" aria-modal="false" aria-live="polite">
    <div class="player-head">
      <div class="player-title" id="playerTitle">Artist</div>
      <div class="player-controls">
        <button class="btn" id="pinToggle">Unpin</button>
        <button class="btn btn-close" id="closePanel">Close</button>
      </div>
    </div>
    <div class="player-body" id="playerBody">
      <!-- YouTube iframe injected here -->
    </div>
    <div class="player-hint">Tip: Click any line to open/replace the player. Drag the window or resize the browser as needed.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script>
  const START_YEAR = 2008;
  const END_YEAR   = 2025;
  const DARK_PINK  = getCss("--dark-pink");
  const LIGHT_PINK = getCss("--light-pink");
  const LIGHT_GRAY = getCss("--light-gray");
  function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

  const svg = d3.select("#chart");
  const statusEl = document.getElementById("status");
  const tooltip = document.getElementById("tooltip");

  const margin = {top: 32, right: 180, bottom: 40, left: 64};
  const width  = 1200 - margin.left - margin.right;
  const height = 700  - margin.top  - margin.bottom;
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
  const x = d3.scalePoint().padding(0.5).range([0, width]);
  const y = d3.scaleLinear().domain([1, 50]).range([0, height]);
  const xAxis = g.append("g").attr("class", "axis x-axis").attr("transform", `translate(0,${height})`);
  const yAxis = g.append("g").attr("class", "axis y-axis");
  const grid = g.append("g").attr("class", "grid");
  const seriesLayer = g.append("g").attr("class", "series-layer");
  const dotsLayer = g.append("g").attr("class", "dots-layer");
  const labelsLayer = g.append("g").attr("class", "labels-layer");
  const hoverVeil = g.append("rect")
      .attr("x",0).attr("y",0).attr("width",width).attr("height",height)
      .attr("fill","transparent")
      .style("pointer-events","none");

  let pinned = null; // when set to artist name, hover highlighting pauses

  // Player panel helpers
  const panel = document.getElementById("playerPanel");
  const playerTitle = document.getElementById("playerTitle");
  const playerBody = document.getElementById("playerBody");
  const pinToggle = document.getElementById("pinToggle");
  const closePanelBtn = document.getElementById("closePanel");

  function openPlayer(artist, anchorEvent) {
    const q = encodeURIComponent(`${artist} official video`);
    const origin = encodeURIComponent(window.location.origin);
    const src = `https://www.youtube.com/embed?listType=search&list=${q}&autoplay=0&origin=${origin}`;
    playerTitle.textContent = artist;
    playerBody.innerHTML = `<iframe src="${src}" title="YouTube player for ${artist}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    panel.style.display = "block";
    // position near click if space allows, else stick bottom-right
    if (anchorEvent) positionPanelNear(anchorEvent.clientX, anchorEvent.clientY);
  }
  function positionPanelNear(cx, cy) {
    const pad = 12;
    const w = Math.min(520, window.innerWidth * 0.92);
    const h = Math.min((w / 16) * 9 + 72, window.innerHeight * 0.9);
    // prefer right/below; adjust if overflows
    let left = cx + pad;
    let top  = cy + pad;
    if (left + w > window.innerWidth) left = cx - w - pad;
    if (top + h > window.innerHeight) top = cy - h - pad;
    if (left < 8) left = 8;
    if (top < 8) top = 8;
    panel.style.left = left + "px";
    panel.style.top  = top + "px";
    panel.style.right = "auto";
    panel.style.bottom = "auto";
  }
  function closePlayer() {
    panel.style.display = "none";
    playerBody.innerHTML = "";
    pinned = null;
    pinToggle.textContent = "Unpin";
  }
  pinToggle.addEventListener("click", () => {
    if (pinned) { pinned = null; pinToggle.textContent = "Unpin"; }
    else { pinned = playerTitle.textContent || null; pinToggle.textContent = "Pinned"; }
  });
  closePanelBtn.addEventListener("click", closePlayer);
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") closePlayer(); });

  // Load the wide CSV
  d3.csv("lastfm_top50.csv").then(raw => {
    const columns = raw.columns;
    let artistKey = columns.find(c => c.toLowerCase().includes("artist")) || columns[0];
    const yearCols = columns.filter(c => /^\d{4}$/.test(c)).map(d => +d).filter(y => y >= START_YEAR && y <= END_YEAR).sort((a,b)=>a-b);
    const years = yearCols.map(String);
    x.domain(years);

    const series = raw.map(row => {
      const name = row[artistKey];
      const points = [];
      let firstNonZeroYear = null;
      let lastNonZeroYear  = null;
      yearCols.forEach(y => {
        const v = +row[String(y)] || 0;
        if (v > 0) {
          const rank = 51 - v; // 50 -> 1
          points.push({ yearLabel: String(y), rank, value: v });
          if (firstNonZeroYear === null) firstNonZeroYear = y;
          lastNonZeroYear = y;
        } else {
          points.push({ yearLabel: String(y), rank: null, value: 0 });
        }
      });
      const inStart = (+row[String(START_YEAR)] || 0) > 0;
      const finalZero = (+row[String(END_YEAR)] || 0) === 0;
      return { artist: name, points, inStart, firstNonZeroYear, lastNonZeroYear, finalZero };
    }).filter(s => s.firstNonZeroYear !== null);

    function topSet(year) {
      const arr = series.map(s => ({ artist: s.artist, value: s.points.find(p => +p.yearLabel===year)?.value || 0 }));
      arr.sort((a,b) => d3.descending(a.value, b.value));
      return new Set(arr.slice(0, 50).filter(d => d.value > 0).map(d => d.artist));
    }
    const top2008 = topSet(START_YEAR);
    const top2025 = topSet(END_YEAR);

    function colorFor(s) {
      if (s.finalZero) return LIGHT_GRAY;
      return s.inStart ? DARK_PINK : LIGHT_PINK;
    }

    // Axes & grid
    xAxis.call(d3.axisBottom(x).tickSizeOuter(0).tickPadding(6));
    yAxis.call(d3.axisLeft(y).tickValues([])); // hide y ticks entirely
    const ranksForGrid = d3.range(5, 51, 5);
    grid.selectAll(".gridline").data(ranksForGrid, d=>d).join(
      enter => enter.append("line").attr("class","gridline").attr("x1",0).attr("x2",width).attr("y1",d=>y(d)).attr("y2",d=>y(d)),
      update => update.attr("y1",d=>y(d)).attr("y2",d=>y(d)),
      exit => exit.remove()
    );

    // Label 2008 and 2025 above
    labelsLayer.append("text").attr("class","year-chip").attr("x", x(String(START_YEAR))).attr("y",-10).attr("text-anchor","middle").text(String(START_YEAR));
    labelsLayer.append("text").attr("class","year-chip").attr("x", x(String(END_YEAR))).attr("y",-10).attr("text-anchor","middle").text(String(END_YEAR));

    const line = d3.line().defined(d => d.rank != null).x(d => x(d.yearLabel)).y(d => y(d.rank)).curve(d3.curveMonotoneX);

    const S = seriesLayer.selectAll(".series").data(series, d => d.artist);
    S.join(
      enter => enter.append("path")
        .attr("class","series")
        .attr("d", d => line(d.points))
        .attr("stroke", d => colorFor(d))
        .on("mousemove", (event, d) => { if (!pinned) showTooltip(event, d); })
        .on("mouseleave", () => { if (!pinned) hideTooltip(); })
        .on("mouseover", function(){ if (!pinned) { seriesLayer.selectAll(".series").classed("hidden", true); d3.select(this).classed("hidden", false).classed("highlight", true); } })
        .on("mouseout", function(){ if (!pinned) { seriesLayer.selectAll(".series").classed("hidden", false).classed("highlight", false); } })
        .on("click", function(event, d){
          event.stopPropagation();
          // pin this selection and open player
          pinned = d.artist;
          seriesLayer.selectAll(".series").classed("hidden", true).classed("highlight", false);
          d3.select(this).classed("hidden", false).classed("highlight", true);
          hideTooltip();
          openPlayer(d.artist, event);
          pinToggle.textContent = "Pinned";
        }),
      update => update.attr("d", d => line(d.points)).attr("stroke", d => colorFor(d)),
      exit => exit.remove()
    );

    // Dots
    dotsLayer.selectAll("*").remove();
    series.forEach(s => {
      dotsLayer.selectAll(null).data(s.points.filter(p => p.rank != null)).enter().append("circle")
        .attr("class","dot").attr("r", 2.6)
        .attr("cx", d => x(d.yearLabel)).attr("cy", d => y(d.rank))
        .attr("fill", colorFor(s)).attr("opacity", .9);
    });

    // End labels
    const leftLabels = series.filter(s => top2008.has(s.artist)).map(s => {
      const p = s.points.find(p => p.yearLabel === String(START_YEAR));
      return p && p.rank != null ? { artist: s.artist, x: x(String(START_YEAR)) - 8, y: y(p.rank), anchor: "end", color: colorFor(s) } : null;
    }).filter(Boolean);
    const rightLabels = series.filter(s => top2025.has(s.artist)).map(s => {
      const p = s.points.find(p => p.yearLabel === String(END_YEAR));
      return p && p.rank != null ? { artist: s.artist, x: x(String(END_YEAR)) + 8, y: y(p.rank), anchor: "start", color: colorFor(s) } : null;
    }).filter(Boolean);
    labelsLayer.selectAll(".label.left").data(leftLabels, d => d.artist).join(enter => enter.append("text").attr("class","label left").attr("x", d => d.x).attr("y", d => d.y).attr("text-anchor", d => d.anchor).attr("fill", d => d.color).text(d => d.artist));
    labelsLayer.selectAll(".label.right").data(rightLabels, d => d.artist).join(enter => enter.append("text").attr("class","label right").attr("x", d => d.x).attr("y", d => d.y).attr("text-anchor", d => d.anchor).attr("fill", d => d.color).text(d => d.artist));

    // Hover anywhere to highlight nearest series when not pinned
    svg
      .on("mousemove", (event) => {
        if (pinned) return;
        let best=null, bestD=Infinity;
        const [mx,my] = d3.pointer(event, g.node());
        for (const s of series) {
          const pts = s.points.filter(p => p.rank != null).map(p => [x(p.yearLabel), y(p.rank)]);
          const d2 = polylineDist2(pts, [mx,my]);
          if (d2 < bestD) { bestD = d2; best = s; }
        }
        if (best) {
          seriesLayer.selectAll(".series").classed("hidden", true).classed("highlight", false);
          seriesLayer.selectAll(".series").filter(d => d && d.artist === best.artist).classed("hidden", false).classed("highlight", true);
          showTooltip(event, best);
        }
      })
      .on("mouseleave", () => {
        if (pinned) return;
        seriesLayer.selectAll(".series").classed("hidden", false).classed("highlight", false);
        hideTooltip();
      })
      .on("click", (event) => {
        if (!pinned) return;
        const target = event.target;
        if (target && target.closest && target.closest(".series")) return; // ignore clicks on lines
        closePlayer();
        seriesLayer.selectAll(".series").classed("hidden", false).classed("highlight", false);
      });

    statusEl.textContent = `Rendered ${series.length} artists across ${years.length} years. Click a line to open a YouTube player.`;
  }).catch(err => {
    console.error(err);
    statusEl.textContent = "Could not load lastfm_top50.csv. Make sure it is next to this HTML and your server allows CSV fetches.";
  });

  // Tooltip helpers
  function showTooltip(event, s) {
    const items = s.points.filter(p => p.rank != null).map(p => `${p.yearLabel}: #${p.rank}`);
    const ranks = items.join("<br>");
    const entry = s.firstNonZeroYear ?? "—";
    const exit  = s.lastNonZeroYear ?? "—";
    const final = s.points.find(p => p.yearLabel===String(END_YEAR))?.value ?? 0;
    tooltip.innerHTML = `<strong>${escapeHtml(s.artist)}</strong><br>
      First year in Top 50: <strong>${entry}</strong><br>
      Last nonzero year: <strong>${exit}</strong><br>
      <br><br>${ranks}`;
    tooltip.style.display = "block";
    positionTooltip(event);
  }
  function hideTooltip(){ tooltip.style.display = "none"; }
  function positionTooltip(event){
    const pad = 12;
    const { clientX:x, clientY:y } = event;
    const w = tooltip.offsetWidth, h = tooltip.offsetHeight;
    let left = x + pad, top = y + pad;
    if (left + w > window.innerWidth) left = x - w - pad;
    if (top + h > window.innerHeight) top = y - h - pad;
    tooltip.style.left = left + "px"; tooltip.style.top  = top  + "px";
  }
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function polylineDist2(pts, p) {
    let best = Infinity;
    for (let i=0; i<pts.length-1; i++) {
      const d2 = segDist2(pts[i], pts[i+1], p);
      if (d2 < best) best = d2;
    }
    return best;
  }
  function segDist2(a,b,p){
    const ax=a[0], ay=a[1], bx=b[0], by=b[1], px=p[0], py=p[1];
    const vx=bx-ax, vy=by-ay, wx=px-ax, wy=py-ay;
    const t = Math.max(0, Math.min(1, (vx*wx+vy*wy)/(vx*vx+vy*vy || 1)));
    const cx=ax+t*vx, cy=ay+t*vy;
    const dx=px-cx, dy=py-cy;
    return dx*dx+dy*dy;
  }
  </script>
</body>
</html>
